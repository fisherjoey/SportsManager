# AI Assignment Wizard - Comprehensive Implementation Plan

## Overview

Replace the existing 3 AI assignment UIs with a unified **3-step wizard** that consolidates functionality while adding:
- **Referee Grouping System** - General-purpose groups (family, friends, carpool, etc.)
- **Enhanced Availability Notes** - Per-entry comments with permanent/situational options
- **LLM Note Interpretation** - DeepSeek parses free-text preferences

---

## User Requirements Summary

| Requirement | Decision |
|-------------|----------|
| UI Strategy | Consolidate all 3 UIs into one wizard |
| Grouping Scope | General-purpose (not just family) |
| Group Links | Both referee self-links AND assigner overrides |
| Proximity Options | Same game, same location, or nearby (configurable) |
| Notes Location | Per-availability entry + option to make permanent |
| LLM Provider | DeepSeek (already integrated, cost-effective) |

---

## Implementation Phases

### Phase 1: Database Migrations
### Phase 2: Backend - Referee Groups API
### Phase 3: Backend - Enhanced Availability API
### Phase 4: Backend - AI Wizard API & Scoring Updates
### Phase 5: Frontend - Wizard Component Architecture
### Phase 6: Frontend - Step 1 (Game Selection)
### Phase 7: Frontend - Step 2 (Configuration)
### Phase 8: Frontend - Step 3 (Run & Review)
### Phase 9: Migration & Deprecation

---

## Phase 1: Database Migrations

**File:** `backend/migrations/YYYYMMDDHHMMSS_add_referee_groups_and_availability_notes.sql`

### New Tables

```sql
-- 1. Referee Groups (permanent, referee-owned)
CREATE TABLE referee_groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    group_type VARCHAR(50) NOT NULL DEFAULT 'general',
    -- 'family', 'friends', 'carpool', 'convenience', 'mentorship', 'training', 'custom'
    custom_type_label VARCHAR(50),
    proximity_preference VARCHAR(30) NOT NULL DEFAULT 'same_location',
    -- 'same_game', 'same_location', 'nearby_location'
    nearby_radius_km INTEGER DEFAULT 10,
    created_by UUID NOT NULL REFERENCES users(id),
    is_open_to_join BOOLEAN DEFAULT false,
    max_members INTEGER DEFAULT 10,
    is_active BOOLEAN DEFAULT true,
    auto_apply_to_availability BOOLEAN DEFAULT true,
    priority INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    archived_at TIMESTAMPTZ
);

-- 2. Group Members
CREATE TABLE referee_group_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    group_id UUID NOT NULL REFERENCES referee_groups(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) DEFAULT 'member', -- 'owner', 'admin', 'member'
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'active', 'declined', 'left', 'removed'
    invited_by UUID REFERENCES users(id),
    can_be_separated BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(group_id, user_id)
);

-- 3. Group Invitations
CREATE TABLE referee_group_invitations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    group_id UUID NOT NULL REFERENCES referee_groups(id) ON DELETE CASCADE,
    invitee_user_id UUID REFERENCES users(id),
    invitee_email VARCHAR(255),
    invited_by UUID NOT NULL REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'pending',
    token VARCHAR(100) UNIQUE,
    expires_at TIMESTAMPTZ DEFAULT (CURRENT_TIMESTAMP + INTERVAL '7 days'),
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 4. Assignment Run Overrides (temporary per-run adjustments)
CREATE TABLE assignment_run_group_overrides (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    rule_id UUID REFERENCES ai_assignment_rules(id) ON DELETE CASCADE,
    override_type VARCHAR(30) NOT NULL,
    -- 'enable_group', 'disable_group', 'create_temporary', 'modify_preference'
    source_group_id UUID REFERENCES referee_groups(id),
    temp_group_name VARCHAR(100),
    temp_group_members UUID[],
    temp_proximity_preference VARCHAR(30),
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 5. Group Scoring Config
CREATE TABLE referee_group_scoring_config (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    rule_id UUID REFERENCES ai_assignment_rules(id) ON DELETE CASCADE UNIQUE,
    family_bonus_percent INTEGER DEFAULT 20,
    friends_bonus_percent INTEGER DEFAULT 10,
    carpool_bonus_percent INTEGER DEFAULT 15,
    mentorship_bonus_percent INTEGER DEFAULT 25,
    same_game_bonus_percent INTEGER DEFAULT 30,
    same_location_bonus_percent INTEGER DEFAULT 20,
    nearby_location_bonus_percent INTEGER DEFAULT 10,
    group_split_penalty_percent INTEGER DEFAULT 15,
    max_group_bonus_percent INTEGER DEFAULT 40,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

### Alter Existing Tables

```sql
-- Add note fields to referee_availability
ALTER TABLE referee_availability
ADD COLUMN note TEXT,
ADD COLUMN is_permanent_note BOOLEAN DEFAULT false;

-- Add group weight to ai_assignment_rules
ALTER TABLE ai_assignment_rules
ADD COLUMN group_preference_weight INTEGER DEFAULT 15
CHECK (group_preference_weight >= 0 AND group_preference_weight <= 100);
```

---

## Phase 2: Backend - Referee Groups API

**New File:** `backend/src/routes/referee-groups.ts`

### Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/referee-groups` | List groups (filter: my_groups, type, status) |
| POST | `/api/referee-groups` | Create group |
| GET | `/api/referee-groups/:id` | Get group with members |
| PUT | `/api/referee-groups/:id` | Update group settings |
| DELETE | `/api/referee-groups/:id` | Archive group (soft delete) |
| POST | `/api/referee-groups/:id/members` | Add member |
| DELETE | `/api/referee-groups/:id/members/:userId` | Remove member |
| POST | `/api/referee-groups/:id/leave` | Leave group (self) |
| POST | `/api/referee-groups/:id/invitations` | Send invitation |
| GET | `/api/referee-groups/invitations/pending` | My pending invitations |
| PUT | `/api/referee-groups/invitations/:id` | Accept/decline invitation |
| GET | `/api/users/:userId/groups` | Get user's groups summary |

### Validation Schema

```typescript
const groupSchema = Joi.object({
  name: Joi.string().required().max(100),
  description: Joi.string().max(500),
  group_type: Joi.string().valid('family', 'friends', 'carpool', 'convenience', 'mentorship', 'training', 'custom'),
  custom_type_label: Joi.string().max(50).when('group_type', { is: 'custom', then: Joi.required() }),
  proximity_preference: Joi.string().valid('same_game', 'same_location', 'nearby_location'),
  nearby_radius_km: Joi.number().min(1).max(100).when('proximity_preference', { is: 'nearby_location', then: Joi.required() }),
  is_open_to_join: Joi.boolean(),
  max_members: Joi.number().min(2).max(20),
  auto_apply_to_availability: Joi.boolean()
});
```

---

## Phase 3: Backend - Enhanced Availability API

**Modify:** `backend/src/routes/availability.ts`

### Changes

1. **Update validation schemas** to include `note` and `is_permanent_note`
2. **Update create/update endpoints** to handle new fields
3. **Add new endpoint** for getting referee notes summary:

```typescript
// GET /api/availability/referees/:id/notes-summary
// Returns all permanent notes + notes in date range for LLM processing
```

---

## Phase 4: Backend - AI Wizard API & Scoring Updates

### New File: `backend/src/routes/ai-assignment-wizard.ts`

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/ai-wizard/preview-games` | Preview games with filters |
| GET | `/api/ai-wizard/referee-config` | Get groups, notes, preferences |
| POST | `/api/ai-wizard/run` | Execute AI assignment |
| GET | `/api/ai-wizard/run/:runId` | Get run results |
| POST | `/api/ai-wizard/apply-assignments` | Apply selected assignments |

### Wizard Run Request

```typescript
interface WizardRunRequest {
  gameIds: string[];
  mode: 'algorithmic' | 'llm';
  dryRun: boolean;
  config: {
    weights: {
      proximity: number;      // default 0.3
      availability: number;   // default 0.4
      experience: number;     // default 0.2
      performance: number;    // default 0.1
      grouping: number;       // default 0.1 (NEW)
    };
    considerGroups: boolean;
    considerAvailabilityNotes: boolean;
    situationalNotes: string[];
    groupOverrides?: GroupOverride[];
    llmSettings?: {
      model: string;          // 'deepseek-chat'
      temperature: number;
      includeAvailabilityNotes: boolean;
    };
  };
}
```

### Modify: `backend/src/routes/ai-suggestions.ts`

Add group scoring to `AIAssignmentService.calculateSuggestion()`:

```typescript
async calculateGroupBonus(
  referee: RefereeData,
  game: GameData,
  existingAssignments: Assignment[],
  config: GroupScoringConfig
): Promise<{ bonus: number; reasoning: string[] }> {
  // 1. Get active groups for this referee
  // 2. Check if group members already assigned to same game/location/nearby
  // 3. Apply type bonus (family: 20%, carpool: 15%, etc.)
  // 4. Apply proximity bonus (same_game: 30%, same_location: 20%, nearby: 10%)
  // 5. Apply split penalty if would separate group
  // 6. Cap at max_group_bonus_percent
}
```

### New Service: `backend/src/services/availabilityNoteParser.ts`

```typescript
class AvailabilityNoteParser {
  async parseNotes(notes: string[], gameContext: GameData): Promise<{
    preferredTimes: string[];
    avoidTimes: string[];
    constraints: string[];
    matchScore: number;
  }> {
    // Use DeepSeek to interpret free-text notes
    // Return structured preferences for scoring
  }
}
```

---

## Phase 5: Frontend - Wizard Component Architecture

**New Directory:** `frontend/components/ai-assignment-wizard/`

```
ai-assignment-wizard/
├── AIAssignmentWizard.tsx         # Main container
├── WizardContext.tsx              # Shared state
├── WizardStepIndicator.tsx        # Progress bar
├── steps/
│   ├── GameSelectionStep.tsx      # Step 1
│   ├── ConfigurationStep.tsx      # Step 2
│   └── RunReviewStep.tsx          # Step 3
├── components/
│   ├── GameFilterPanel.tsx
│   ├── GameSelectionTable.tsx
│   ├── RefereeGroupManager.tsx
│   ├── AvailabilityNotesPanel.tsx
│   ├── WeightSliders.tsx
│   ├── AssignmentPreview.tsx
│   └── AssignmentConfirmation.tsx
├── hooks/
│   ├── useWizardState.ts
│   ├── useGameSelection.ts
│   └── useAssignmentRun.ts
└── types/
    └── wizard.types.ts
```

### Wizard State

```typescript
interface WizardState {
  currentStep: 1 | 2 | 3;
  selectedGames: Game[];
  configuration: {
    mode: 'algorithmic' | 'llm';
    weights: { proximity, availability, experience, performance, grouping };
    considerGroups: boolean;
    considerAvailabilityNotes: boolean;
    situationalNotes: string[];
    groupOverrides: GroupOverride[];
  };
  runResults: RunResults | null;
  selectedAssignments: string[];
}
```

---

## Phase 6: Frontend - Step 1 (Game Selection)

### Features
- Date range filter (start/end pickers)
- Location dropdown filter
- Level filter
- Status filter (unassigned default)
- Multi-select checkbox table
- "Select All Unassigned" action
- Selected count preview

### API Integration
- Uses existing `/api/games` with filters
- `POST /api/ai-wizard/preview-games` for validation

---

## Phase 7: Frontend - Step 2 (Configuration)

### Sub-sections

1. **Referee Groups Panel**
   - List active groups with member count
   - Toggle groups for this run
   - Quick view members
   - Create temporary grouping

2. **Availability Notes Panel**
   - List referees with notes
   - Add situational notes
   - Toggle LLM interpretation

3. **Algorithm Config**
   - Weight sliders (proximity, availability, experience, performance, grouping)
   - Preset buttons (Balanced, Proximity-first, Experience-first)
   - Algorithmic vs LLM toggle
   - LLM settings (if selected)

---

## Phase 8: Frontend - Step 3 (Run & Review)

### Features
- "Run Dry Preview" button
- Results table:
  - Game info (teams, date, time, location)
  - Assigned referees with confidence scores
  - Group badges showing memberships
  - Reasoning text
  - Warnings/conflicts
- Checkbox selection per assignment
- "Apply Selected" / "Apply All" buttons
- Summary stats

---

## Phase 9: Migration & Deprecation

### Files to Replace
- `frontend/components/ai-assignments-page.tsx` (1257 lines)
- `frontend/components/ai-assignments-enterprise.tsx` (1065 lines)
- `frontend/components/ai-assignments-simple.tsx` (959 lines)

### Migration Steps
1. Feature flag for wizard (`USE_AI_WIZARD=true`)
2. Update routes to use wizard
3. Keep old UIs accessible for 2 weeks
4. Remove old files after validation

---

## Critical Files to Modify

| File | Changes |
|------|---------|
| `backend/src/routes/availability.ts` | Add note, is_permanent_note fields |
| `backend/src/routes/ai-suggestions.ts` | Add group scoring to calculateSuggestion |
| `backend/src/routes/ai-assignment-rules.ts` | Add group_preference_weight |
| `frontend/lib/api.ts` | Add wizard + groups API methods |

### New Files to Create

| File | Purpose |
|------|---------|
| `backend/migrations/*_add_referee_groups.sql` | Database schema |
| `backend/src/routes/referee-groups.ts` | Groups CRUD API |
| `backend/src/routes/ai-assignment-wizard.ts` | Wizard API |
| `backend/src/services/availabilityNoteParser.ts` | LLM note parsing |
| `frontend/components/ai-assignment-wizard/*` | All wizard components |

---

## Group Joining Method

**Decision:** Invitation-only for MVP
- Referees create groups and invite specific people by name/email
- No public group discovery/browsing initially
- Can add discovery feature later if needed

---

## Edge Cases Handled

| Case | Solution |
|------|----------|
| Conflicting availability in group | Check overlap first, only apply bonus if >50% available |
| One group member unavailable | Allow partial bonus, log outcome |
| Referee in multiple groups | Stack bonuses, cap at max, use priority for conflicts |
| Different experience levels | Validate minimum required, allow warning for large gaps |
| Group too large | Enforce max_members at DB and API level |
| LLM service unavailable | Fallback to algorithmic only |

---

## Implementation Order

1. **Database migrations** - foundation for everything
2. **Referee Groups API** - can be tested independently
3. **Enhanced Availability API** - simple extension
4. **Wizard API endpoints** - core logic
5. **Group scoring integration** - modify existing service
6. **Frontend wizard skeleton** - step navigation
7. **Step 1 (Game Selection)** - uses existing APIs
8. **Step 2 (Configuration)** - groups + notes UI
9. **Step 3 (Run & Review)** - results display
10. **LLM note parsing** - enhancement layer
11. **Testing & migration** - feature flag rollout

---

## Parallel Agent Session Guide

This project can be split across multiple Claude Code agents working simultaneously. Here's how to divide the work:

### Session 1: Backend - Database & Groups API (Phases 1-2)
**Focus:** Database foundation and referee groups
```
Tasks:
1. Create migration file: backend/migrations/*_add_referee_groups.sql
2. Run migration
3. Create backend/src/routes/referee-groups.ts (full CRUD)
4. Register routes in backend/src/index.ts
5. Test endpoints with Postman/curl
```
**Dependencies:** None - can start immediately
**Deliverable:** Working `/api/referee-groups/*` endpoints

---

### Session 2: Backend - Availability & Wizard API (Phases 3-4)
**Focus:** Enhanced availability and wizard endpoints
```
Tasks:
1. Modify backend/src/routes/availability.ts (add note fields)
2. Create backend/src/routes/ai-assignment-wizard.ts
3. Create backend/src/services/availabilityNoteParser.ts
4. Modify backend/src/routes/ai-suggestions.ts (add group scoring)
5. Register new routes
```
**Dependencies:** Needs Phase 1 migrations complete
**Deliverable:** Working `/api/ai-wizard/*` endpoints

---

### Session 3: Frontend - Wizard Shell & Step 1 (Phases 5-6)
**Focus:** Wizard component structure and game selection
```
Tasks:
1. Create frontend/components/ai-assignment-wizard/ directory structure
2. Build AIAssignmentWizard.tsx (main container)
3. Build WizardContext.tsx (state management)
4. Build WizardStepIndicator.tsx
5. Build GameSelectionStep.tsx with filters
6. Add API methods to frontend/lib/api.ts
```
**Dependencies:** None for UI shell; needs Session 2 for full integration
**Deliverable:** Working Step 1 UI with game selection

---

### Session 4: Frontend - Steps 2 & 3 (Phases 7-8)
**Focus:** Configuration and results UI
```
Tasks:
1. Build ConfigurationStep.tsx
2. Build RefereeGroupManager.tsx
3. Build AvailabilityNotesPanel.tsx
4. Build WeightSliders.tsx
5. Build RunReviewStep.tsx
6. Build AssignmentPreview.tsx
```
**Dependencies:** Needs Session 3 wizard shell complete
**Deliverable:** Complete wizard UI

---

### Recommended Parallel Execution

```
Timeline:
├── Session 1 (Backend DB/Groups) ─────────────────►
├── Session 3 (Frontend Shell) ────────────────────►
│
│   [Wait for Session 1 migrations]
│
├── Session 2 (Backend Wizard API) ────────────────►
│
│   [Wait for Session 3 shell]
│
└── Session 4 (Frontend Steps 2-3) ────────────────►
```

**Best parallel pairs:**
- Session 1 + Session 3 (no dependencies, can run simultaneously)
- Session 2 + Session 4 (after their dependencies complete)

---

### Handoff Checklist Between Sessions

When completing a session, leave these notes for the next agent:

1. **Files created/modified** - list all changed files
2. **Migration status** - did migrations run successfully?
3. **Routes registered** - are new routes added to index.ts?
4. **API client updated** - are new methods in frontend/lib/api.ts?
5. **Known issues** - any bugs or TODOs left behind
6. **Test commands** - how to verify the work is complete

---

### Starting a New Agent Session

Give the new agent this context:
```
Project: SportsManager - AI Assignment Wizard
Plan file: C:\dev\Synced\SportsManager\docs\ai-assignment-wizard-plan.txt
Your focus: [Session X - description]
Previous sessions completed: [list]
Start from: Phase X, Step Y
```
