---
apiVersion: api.cerbos.dev/v1
description: Policy for assignment resource
resourcePolicy:
  version: "default"
  importDerivedRoles:
    - common_roles
  resource: "assignment"
  rules:
    # Admin rules - full access within their organization
    - actions: ['view:list', 'view:details', 'create', 'update', 'delete', 'change_status']
      effect: EFFECT_ALLOW
      roles:
        - admin
      derivedRoles:
        - organization_admin

    # Assignor rules
    - actions: ['view:list', 'view:details']
      effect: EFFECT_ALLOW
      roles:
        - assignor
      derivedRoles:
        - same_organization
        - same_region

    - actions: ['create']
      effect: EFFECT_ALLOW
      roles:
        - assignor
      condition:
        match:
          all:
            of:
              - expr: request.resource.attr.organizationId == request.principal.attr.organizationId
              - expr: request.resource.attr.gameRegionId in request.principal.attr.regionIds

    - actions: ['update']
      effect: EFFECT_ALLOW
      roles:
        - assignor
      derivedRoles:
        - same_organization
      condition:
        match:
          all:
            of:
              - expr: request.resource.attr.organizationId == request.principal.attr.organizationId
              - expr: request.resource.attr.status in ["pending", "offered"]

    - actions: ['delete']
      effect: EFFECT_ALLOW
      roles:
        - assignor
      derivedRoles:
        - owner
      condition:
        match:
          all:
            of:
              - expr: request.resource.attr.organizationId == request.principal.attr.organizationId
              - expr: request.resource.attr.status != "completed"

    # Referee rules - can view their own assignments
    - actions: ['view:list', 'view:details']
      effect: EFFECT_ALLOW
      roles:
        - referee
      condition:
        match:
          any:
            of:
              - expr: request.resource.attr.refereeId == request.principal.id
              - expr: >
                  request.resource.attr.organizationId == request.principal.attr.organizationId &&
                  request.resource.attr.gameRegionId in request.principal.attr.regionIds

    # Referee can accept/decline their own assignments
    - actions: ['change_status']
      effect: EFFECT_ALLOW
      roles:
        - referee
      condition:
        match:
          all:
            of:
              - expr: request.resource.attr.refereeId == request.principal.id
              - expr: request.resource.attr.status in ["pending", "offered"]

    # Referee can update their own assignments (e.g., add notes)
    - actions: ['update']
      effect: EFFECT_ALLOW
      roles:
        - referee
      condition:
        match:
          all:
            of:
              - expr: request.resource.attr.refereeId == request.principal.id
              - expr: request.resource.attr.status in ["confirmed", "completed"]

    # Guest rules - no access
    - actions: ['*']
      effect: EFFECT_DENY
      roles:
        - guest