<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/query-performance.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/query-performance.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Database Query Performance Monitoring - Package 3C
 * @description Advanced database query performance tracking, optimization detection,
 * and recommendation system that integrates with existing query builders and cache.
 */

const { EventEmitter } = require('events');

// Lazy load dependencies to avoid circular references
let queryCache = null;
let QueryBuilder = null;

function getQueryCache() {
  if (!queryCache) {
    try {
      const cacheModule = require('./query-cache');
      queryCache = cacheModule.queryCache || { getStats: () => ({}) };
    } catch (error) {
      queryCache = { getStats: () => ({}) };
    }
  }
  return queryCache;
}

function getQueryBuilder() {
  if (!QueryBuilder) {
    try {
      const builderModule = require('./query-builders');
      QueryBuilder = builderModule.QueryBuilder || {};
    } catch (error) {
      QueryBuilder = {};
    }
  }
  return QueryBuilder;
}

/**
 * Query performance event emitter
 */
const queryPerformanceEvents = new EventEmitter();

/**
 * Database Query Performance Analyzer
 */
class QueryPerformanceAnalyzer {
  constructor() {
    this.queries = new Map(); // Query fingerprint -> performance data
    this.slowQueries = [];
    this.queryPatterns = new Map(); // Pattern -> frequency
    this.tableStats = new Map(); // Table -> access patterns
    this.indexUsage = new Map(); // Index -> usage stats
    this.connectionPool = {
      active: 0,
      idle: 0,
      waiting: 0,
      max: 10,
      history: []
    };
    
    this.config = {
      slowQueryThreshold: 500, // 500ms
      verySlowQueryThreshold: 2000, // 2 seconds
      maxSlowQueries: 1000,
      maxQueryFingerprints: 5000,
      enableQueryPlanAnalysis: true,
      trackIndexUsage: true,
      connectionPoolMonitoring: true
    };
    
    this.startConnectionPoolMonitoring();
  }

  /**
   * Analyze and record query performance
   */
  analyzeQuery(sql, duration, bindings = [], result = null, error = null) {
    const fingerprint = this.generateQueryFingerprint(sql);
    const queryInfo = this.parseQuery(sql);
    const timestamp = Date.now();
    
    // Get or create query stats
    if (!this.queries.has(fingerprint)) {
      this.queries.set(fingerprint, {
        fingerprint,
        sql: this.normalizeQuery(sql),
        table: queryInfo.table,
        operation: queryInfo.operation,
        firstSeen: timestamp,
        lastSeen: timestamp,
        count: 0,
        totalTime: 0,
        averageTime: 0,
        minTime: Infinity,
        maxTime: 0,
        slowCount: 0,
        verySlowCount: 0,
        errorCount: 0,
        cacheHits: 0,
        cacheMisses: 0,
        rowsAffected: [],
        executionPlans: [],
        recommendations: new Set()
      });
    }
    
    const queryStats = this.queries.get(fingerprint);
    
    // Update statistics
    queryStats.count++;
    queryStats.totalTime += duration;
    queryStats.averageTime = queryStats.totalTime / queryStats.count;
    queryStats.minTime = Math.min(queryStats.minTime, duration);
    queryStats.maxTime = Math.max(queryStats.maxTime, duration);
    queryStats.lastSeen = timestamp;
    
    if (error) {
      queryStats.errorCount++;
      this.emitQueryEvent('query_error', {
        fingerprint,
        sql: queryStats.sql,
        duration,
        error: error.message,
        table: queryInfo.table
      });
    }
    
    // Track rows affected if available
    if (result &amp;&amp; result.rowCount !== undefined) {
      queryStats.rowsAffected.push(result.rowCount);
      if (queryStats.rowsAffected.length > 100) {
        queryStats.rowsAffected.shift();
      }
    }
    
    // Categorize by performance
    if (duration > this.config.verySlowQueryThreshold) {
      queryStats.verySlowCount++;
      this.addSlowQuery({
        fingerprint,
        sql: queryStats.sql,
        duration,
        timestamp,
        table: queryInfo.table,
        operation: queryInfo.operation,
        severity: 'very_slow',
        bindings,
        rowsAffected: result?.rowCount
      });
      
      this.emitQueryEvent('very_slow_query', {
        fingerprint,
        sql: queryStats.sql,
        duration,
        table: queryInfo.table,
        operation: queryInfo.operation
      });
    } else if (duration > this.config.slowQueryThreshold) {
      queryStats.slowCount++;
      this.addSlowQuery({
        fingerprint,
        sql: queryStats.sql,
        duration,
        timestamp,
        table: queryInfo.table,
        operation: queryInfo.operation,
        severity: 'slow',
        bindings,
        rowsAffected: result?.rowCount
      });
      
      this.emitQueryEvent('slow_query', {
        fingerprint,
        sql: queryStats.sql,
        duration,
        table: queryInfo.table,
        operation: queryInfo.operation
      });
    }
    
    // Update table statistics
    this.updateTableStats(queryInfo.table, queryInfo.operation, duration);
    
    // Update query patterns
    this.updateQueryPatterns(queryInfo);
    
    // Generate recommendations
    this.generateQueryRecommendations(queryStats, queryInfo);
    
    // Cleanup old entries if needed
    this.cleanupOldEntries();
    
    return {
      fingerprint,
      duration,
      performance: this.classifyPerformance(duration),
      recommendations: Array.from(queryStats.recommendations)
    };
  }

  /**
   * Generate unique fingerprint for query
   */
  generateQueryFingerprint(sql) {
    // Normalize SQL for fingerprinting
    const normalized = sql
      .replace(/\s+/g, ' ')
      .replace(/\$\d+/g, '?') // Replace parameterized queries
      .replace(/'[^']*'/g, '?') // Replace string literals
      .replace(/\b\d+\b/g, '?') // Replace numbers
      .toLowerCase()
      .trim();
    
    // Simple hash function
    let hash = 0;
    for (let i = 0; i &lt; normalized.length; i++) {
      const char = normalized.charCodeAt(i);
      hash = ((hash &lt;&lt; 5) - hash) + char;
      hash = hash &amp; hash; // Convert to 32-bit integer
    }
    
    return `query_${Math.abs(hash).toString(36)}`;
  }

  /**
   * Parse query to extract metadata
   */
  parseQuery(sql) {
    const cleanSql = sql.toLowerCase().trim();
    
    // Extract operation
    let operation = 'unknown';
    if (cleanSql.startsWith('select')) operation = 'select';
    else if (cleanSql.startsWith('insert')) operation = 'insert';
    else if (cleanSql.startsWith('update')) operation = 'update';
    else if (cleanSql.startsWith('delete')) operation = 'delete';
    else if (cleanSql.startsWith('create')) operation = 'create';
    else if (cleanSql.startsWith('drop')) operation = 'drop';
    else if (cleanSql.startsWith('alter')) operation = 'alter';
    else if (cleanSql.includes('join')) operation = 'join';
    
    // Extract table names
    const tables = this.extractTableNames(sql);
    const primaryTable = tables.length > 0 ? tables[0] : 'unknown';
    
    // Detect query patterns
    const patterns = [];
    if (cleanSql.includes('where')) patterns.push('filtered');
    if (cleanSql.includes('order by')) patterns.push('sorted');
    if (cleanSql.includes('group by')) patterns.push('grouped');
    if (cleanSql.includes('limit')) patterns.push('limited');
    if (cleanSql.includes('join')) patterns.push('joined');
    if (cleanSql.includes('subquery') || cleanSql.includes('select') &amp;&amp; cleanSql.match(/select/g).length > 1) {
      patterns.push('complex');
    }
    
    return {
      operation,
      table: primaryTable,
      tables,
      patterns,
      complexity: this.calculateQueryComplexity(cleanSql, patterns)
    };
  }

  /**
   * Extract table names from SQL
   */
  extractTableNames(sql) {
    const tables = [];
    const tablePatterns = [
      /(?:from|into|update|join)\s+["`]?(\w+)["`]?/gi,
      /(?:table\s+)["`]?(\w+)["`]?/gi
    ];
    
    for (const pattern of tablePatterns) {
      let match;
      while ((match = pattern.exec(sql)) !== null) {
        const tableName = match[1].toLowerCase();
        if (!tables.includes(tableName)) {
          tables.push(tableName);
        }
      }
    }
    
    return tables;
  }

  /**
   * Calculate query complexity score
   */
  calculateQueryComplexity(sql, patterns) {
    let complexity = 1;
    
    // Base complexity on patterns
    if (patterns.includes('joined')) complexity += 2;
    if (patterns.includes('complex')) complexity += 3;
    if (patterns.includes('grouped')) complexity += 1;
    if (patterns.includes('sorted')) complexity += 1;
    
    // Count subqueries
    const subqueryCount = (sql.match(/select/gi) || []).length - 1;
    complexity += subqueryCount * 2;
    
    // Count joins
    const joinCount = (sql.match(/join/gi) || []).length;
    complexity += joinCount;
    
    return Math.min(complexity, 10); // Cap at 10
  }

  /**
   * Normalize query for display
   */
  normalizeQuery(sql) {
    return sql
      .replace(/\s+/g, ' ')
      .replace(/\$\d+/g, '?')
      .trim()
      .substring(0, 500); // Truncate long queries
  }

  /**
   * Add slow query to tracking
   */
  addSlowQuery(queryData) {
    this.slowQueries.push(queryData);
    
    // Keep only recent slow queries
    if (this.slowQueries.length > this.config.maxSlowQueries) {
      this.slowQueries.shift();
    }
  }

  /**
   * Update table access statistics
   */
  updateTableStats(table, operation, duration) {
    if (!this.tableStats.has(table)) {
      this.tableStats.set(table, {
        table,
        totalQueries: 0,
        totalTime: 0,
        averageTime: 0,
        operations: new Map(),
        slowQueries: 0,
        lastAccessed: Date.now(),
        accessPattern: 'unknown'
      });
    }
    
    const stats = this.tableStats.get(table);
    stats.totalQueries++;
    stats.totalTime += duration;
    stats.averageTime = stats.totalTime / stats.totalQueries;
    stats.lastAccessed = Date.now();
    
    if (duration > this.config.slowQueryThreshold) {
      stats.slowQueries++;
    }
    
    // Update operation stats
    if (!stats.operations.has(operation)) {
      stats.operations.set(operation, { count: 0, totalTime: 0, averageTime: 0 });
    }
    
    const opStats = stats.operations.get(operation);
    opStats.count++;
    opStats.totalTime += duration;
    opStats.averageTime = opStats.totalTime / opStats.count;
    
    // Determine access pattern
    stats.accessPattern = this.determineAccessPattern(stats);
  }

  /**
   * Determine table access pattern
   */
  determineAccessPattern(stats) {
    const readOps = (stats.operations.get('select') || { count: 0 }).count;
    const writeOps = ['insert', 'update', 'delete'].reduce((sum, op) => {
      return sum + (stats.operations.get(op) || { count: 0 }).count;
    }, 0);
    
    const total = readOps + writeOps;
    if (total === 0) return 'unknown';
    
    const readRatio = readOps / total;
    
    if (readRatio > 0.9) return 'read_heavy';
    if (readRatio &lt; 0.1) return 'write_heavy';
    if (readRatio > 0.7) return 'read_mostly';
    if (readRatio &lt; 0.3) return 'write_mostly';
    return 'balanced';
  }

  /**
   * Update query pattern statistics
   */
  updateQueryPatterns(queryInfo) {
    const patternKey = `${queryInfo.operation}_${queryInfo.patterns.sort().join('_')}`;
    
    if (!this.queryPatterns.has(patternKey)) {
      this.queryPatterns.set(patternKey, {
        pattern: patternKey,
        operation: queryInfo.operation,
        patterns: queryInfo.patterns,
        count: 0,
        averageComplexity: 0,
        totalComplexity: 0
      });
    }
    
    const pattern = this.queryPatterns.get(patternKey);
    pattern.count++;
    pattern.totalComplexity += queryInfo.complexity;
    pattern.averageComplexity = pattern.totalComplexity / pattern.count;
  }

  /**
   * Generate performance recommendations for query
   */
  generateQueryRecommendations(queryStats, queryInfo) {
    const recommendations = queryStats.recommendations;
    
    // High error rate
    if (queryStats.errorCount > queryStats.count * 0.1) {
      recommendations.add({
        type: 'high_error_rate',
        message: `Query has high error rate (${((queryStats.errorCount / queryStats.count) * 100).toFixed(1)}%). Review query logic and error handling.`,
        priority: 'high'
      });
    }
    
    // Consistently slow
    if (queryStats.averageTime > this.config.slowQueryThreshold &amp;&amp; queryStats.count > 10) {
      recommendations.add({
        type: 'consistently_slow',
        message: `Query averages ${queryStats.averageTime.toFixed(0)}ms. Consider adding indexes or optimizing query structure.`,
        priority: 'high'
      });
    }
    
    // High frequency, moderate performance
    if (queryStats.count > 100 &amp;&amp; queryStats.averageTime > 100) {
      recommendations.add({
        type: 'cache_candidate',
        message: `High-frequency query (${queryStats.count} executions) with moderate performance. Consider caching results.`,
        priority: 'medium'
      });
    }
    
    // Complex queries
    if (queryInfo.complexity > 5 &amp;&amp; queryStats.averageTime > 200) {
      recommendations.add({
        type: 'complex_query',
        message: `Complex query with moderate performance. Consider breaking into smaller queries or optimizing joins.`,
        priority: 'medium'
      });
    }
    
    // Table-specific recommendations
    const tableStats = this.tableStats.get(queryInfo.table);
    if (tableStats &amp;&amp; tableStats.slowQueries > tableStats.totalQueries * 0.2) {
      recommendations.add({
        type: 'table_performance',
        message: `Table '${queryInfo.table}' has high percentage of slow queries. Consider adding indexes.`,
        priority: 'medium'
      });
    }
    
    // N+1 query detection (simplified)
    if (queryInfo.operation === 'select' &amp;&amp; queryStats.count > 50 &amp;&amp; queryStats.averageTime &lt; 50) {
      const similarQueries = Array.from(this.queries.values())
        .filter(q => q.table === queryInfo.table &amp;&amp; q.operation === 'select' &amp;&amp; q.count > 50);
      
      if (similarQueries.length > 1) {
        recommendations.add({
          type: 'potential_n_plus_1',
          message: `Potential N+1 query pattern detected for table '${queryInfo.table}'. Consider using joins or batch loading.`,
          priority: 'medium'
        });
      }
    }
  }

  /**
   * Classify query performance
   */
  classifyPerformance(duration) {
    if (duration > this.config.verySlowQueryThreshold) return 'very_slow';
    if (duration > this.config.slowQueryThreshold) return 'slow';
    if (duration > 100) return 'moderate';
    if (duration > 50) return 'good';
    return 'excellent';
  }

  /**
   * Start connection pool monitoring
   */
  startConnectionPoolMonitoring() {
    if (!this.config.connectionPoolMonitoring) return;
    
    const monitorPool = () => {
      // This would integrate with your actual database connection pool
      // For now, simulate connection pool metrics
      const timestamp = Date.now();
      
      this.connectionPool.history.push({
        timestamp,
        active: this.connectionPool.active,
        idle: this.connectionPool.idle,
        waiting: this.connectionPool.waiting
      });
      
      // Keep only last 100 entries
      if (this.connectionPool.history.length > 100) {
        this.connectionPool.history.shift();
      }
      
      // Alert on connection pool issues
      if (this.connectionPool.waiting > 0) {
        this.emitQueryEvent('connection_pool_waiting', {
          waiting: this.connectionPool.waiting,
          active: this.connectionPool.active,
          idle: this.connectionPool.idle
        });
      }
      
      if (this.connectionPool.active > this.connectionPool.max * 0.9) {
        this.emitQueryEvent('connection_pool_near_limit', {
          active: this.connectionPool.active,
          max: this.connectionPool.max,
          utilization: (this.connectionPool.active / this.connectionPool.max) * 100
        });
      }
    };
    
    // Monitor every 10 seconds
    this.poolMonitorInterval = setInterval(monitorPool, 10000);
  }

  /**
   * Emit query performance event
   */
  emitQueryEvent(type, data) {
    queryPerformanceEvents.emit('query_event', {
      type,
      data,
      timestamp: Date.now()
    });
  }

  /**
   * Get comprehensive performance statistics
   */
  getPerformanceStats() {
    const now = Date.now();
    
    // Convert Maps to Objects for JSON serialization
    const queryStats = Array.from(this.queries.values())
      .sort((a, b) => b.averageTime - a.averageTime)
      .slice(0, 50); // Top 50 slowest queries
    
    const tableStats = Array.from(this.tableStats.values())
      .sort((a, b) => b.averageTime - a.averageTime);
    
    const queryPatterns = Array.from(this.queryPatterns.values())
      .sort((a, b) => b.count - a.count);
    
    // Calculate summary statistics
    const totalQueries = Array.from(this.queries.values())
      .reduce((sum, q) => sum + q.count, 0);
    
    const totalTime = Array.from(this.queries.values())
      .reduce((sum, q) => sum + q.totalTime, 0);
    
    const slowQueries = Array.from(this.queries.values())
      .reduce((sum, q) => sum + q.slowCount, 0);
    
    const verySlowQueries = Array.from(this.queries.values())
      .reduce((sum, q) => sum + q.verySlowCount, 0);
    
    const errorCount = Array.from(this.queries.values())
      .reduce((sum, q) => sum + q.errorCount, 0);
    
    return {
      summary: {
        totalQueries,
        totalTime,
        averageTime: totalQueries > 0 ? totalTime / totalQueries : 0,
        slowQueries,
        verySlowQueries,
        errorCount,
        slowQueryPercentage: totalQueries > 0 ? (slowQueries / totalQueries) * 100 : 0,
        errorPercentage: totalQueries > 0 ? (errorCount / totalQueries) * 100 : 0,
        uniqueQueries: this.queries.size,
        monitoredTables: this.tableStats.size
      },
      
      topSlowQueries: queryStats.slice(0, 10).map(q => ({
        fingerprint: q.fingerprint,
        sql: q.sql,
        table: q.table,
        operation: q.operation,
        count: q.count,
        averageTime: Math.round(q.averageTime),
        maxTime: q.maxTime,
        slowCount: q.slowCount,
        errorCount: q.errorCount,
        recommendations: Array.from(q.recommendations)
      })),
      
      tablePerformance: tableStats.map(t => ({
        table: t.table,
        totalQueries: t.totalQueries,
        averageTime: Math.round(t.averageTime),
        slowQueries: t.slowQueries,
        accessPattern: t.accessPattern,
        operations: Object.fromEntries(t.operations),
        lastAccessed: t.lastAccessed
      })),
      
      queryPatterns: queryPatterns.slice(0, 20),
      
      recentSlowQueries: this.slowQueries
        .slice(-20)
        .map(q => ({
          sql: q.sql,
          duration: q.duration,
          table: q.table,
          operation: q.operation,
          severity: q.severity,
          timestamp: q.timestamp
        })),
      
      connectionPool: {
        ...this.connectionPool,
        utilization: this.connectionPool.max > 0 
          ? (this.connectionPool.active / this.connectionPool.max) * 100 
          : 0
      },
      
      recommendations: [], // Generate recommendations separately to avoid circular calls
      
      timestamp: now
    };
  }

  /**
   * Generate global performance recommendations
   */
  generateGlobalRecommendations() {
    const recommendations = [];
    
    // Don't call getPerformanceStats() to avoid circular calls
    const totalQueries = Array.from(this.queries.values())
      .reduce((sum, q) => sum + q.count, 0);
    
    const slowQueries = Array.from(this.queries.values())
      .reduce((sum, q) => sum + q.slowCount, 0);
      
    const errorCount = Array.from(this.queries.values())
      .reduce((sum, q) => sum + q.errorCount, 0);
    
    const slowQueryPercentage = totalQueries > 0 ? (slowQueries / totalQueries) * 100 : 0;
    const errorPercentage = totalQueries > 0 ? (errorCount / totalQueries) * 100 : 0;
    
    const stats = {
      summary: {
        slowQueryPercentage,
        errorPercentage,
        totalQueries
      },
      connectionPool: this.connectionPool,
      tablePerformance: Array.from(this.tableStats.values())
        .sort((a, b) => b.averageTime - a.averageTime)
    };
    
    // High percentage of slow queries
    if (stats.summary.slowQueryPercentage > 20) {
      recommendations.push({
        type: 'high_slow_query_rate',
        message: `${stats.summary.slowQueryPercentage.toFixed(1)}% of queries are slow. Review database indexes and query optimization.`,
        priority: 'high'
      });
    }
    
    // High error rate
    if (stats.summary.errorPercentage > 5) {
      recommendations.push({
        type: 'high_error_rate',
        message: `${stats.summary.errorPercentage.toFixed(1)}% of queries result in errors. Review query logic and database constraints.`,
        priority: 'high'
      });
    }
    
    // Connection pool utilization
    if (stats.connectionPool.utilization > 80) {
      recommendations.push({
        type: 'high_connection_utilization',
        message: `Connection pool is ${stats.connectionPool.utilization.toFixed(1)}% utilized. Consider increasing pool size or optimizing query performance.`,
        priority: 'medium'
      });
    }
    
    // Most problematic tables
    const problematicTables = stats.tablePerformance
      .filter(t => t.slowQueries > t.totalQueries * 0.3)
      .slice(0, 3);
    
    problematicTables.forEach(table => {
      recommendations.push({
        type: 'problematic_table',
        message: `Table '${table.table}' has poor performance (${((table.slowQueries / table.totalQueries) * 100).toFixed(1)}% slow queries). Consider adding indexes.`,
        priority: 'medium'
      });
    });
    
    return recommendations;
  }

  /**
   * Cleanup old entries to prevent memory leaks
   */
  cleanupOldEntries() {
    // Remove old query fingerprints if we have too many
    if (this.queries.size > this.config.maxQueryFingerprints) {
      const oldestEntries = Array.from(this.queries.entries())
        .sort(([, a], [, b]) => a.lastSeen - b.lastSeen)
        .slice(0, Math.floor(this.config.maxQueryFingerprints * 0.1)); // Remove oldest 10%
      
      oldestEntries.forEach(([fingerprint]) => {
        this.queries.delete(fingerprint);
      });
    }
  }

  /**
   * Reset all statistics
   */
  reset() {
    this.queries.clear();
    this.slowQueries.length = 0;
    this.queryPatterns.clear();
    this.tableStats.clear();
    this.indexUsage.clear();
    
    this.connectionPool = {
      active: 0,
      idle: 0,
      waiting: 0,
      max: 10,
      history: []
    };
  }

  /**
   * Cleanup resources
   */
  cleanup() {
    if (this.poolMonitorInterval) {
      clearInterval(this.poolMonitorInterval);
    }
  }
}

// Global analyzer instance
const queryAnalyzer = new QueryPerformanceAnalyzer();

/**
 * Wrap database connection with performance monitoring
 */
function wrapDatabaseConnection(db, options = {}) {
  const { enablePerformanceTracking = true, trackConnectionPool = true } = options;
  
  if (!enablePerformanceTracking) return db;
  
  // Track connection pool events if supported
  if (trackConnectionPool &amp;&amp; db.pool) {
    db.pool.on('createSuccess', () => {
      queryAnalyzer.connectionPool.active++;
    });
    
    db.pool.on('createFail', () => {
      queryAnalyzer.emitQueryEvent('connection_create_failed', {});
    });
    
    db.pool.on('destroySuccess', () => {
      queryAnalyzer.connectionPool.active--;
    });
    
    db.pool.on('acquireRequest', () => {
      queryAnalyzer.connectionPool.waiting++;
    });
    
    db.pool.on('acquireSuccess', () => {
      queryAnalyzer.connectionPool.waiting--;
      queryAnalyzer.connectionPool.idle--;
    });
    
    db.pool.on('release', () => {
      queryAnalyzer.connectionPool.idle++;
    });
  }
  
  // Wrap query methods
  const originalRaw = db.raw;
  db.raw = function(sql, bindings) {
    const startTime = process.hrtime.bigint();
    
    const result = originalRaw.call(this, sql, bindings);
    
    if (result &amp;&amp; typeof result.then === 'function') {
      return result
        .then(data => {
          const endTime = process.hrtime.bigint();
          const duration = Number(endTime - startTime) / 1000000; // milliseconds
          
          queryAnalyzer.analyzeQuery(sql, duration, bindings, data);
          return data;
        })
        .catch(error => {
          const endTime = process.hrtime.bigint();
          const duration = Number(endTime - startTime) / 1000000;
          
          queryAnalyzer.analyzeQuery(sql, duration, bindings, null, error);
          throw error;
        });
    }
    
    return result;
  };
  
  return db;
}

/**
 * Get query performance events
 */
function getQueryPerformanceEvents() {
  return queryPerformanceEvents;
}

/**
 * Get query performance statistics
 */
function getQueryPerformanceStats() {
  return queryAnalyzer.getPerformanceStats();
}

/**
 * Reset query performance statistics
 */
function resetQueryPerformanceStats() {
  queryAnalyzer.reset();
}

/**
 * Cleanup on process exit
 */
process.on('exit', () => {
  queryAnalyzer.cleanup();
});

module.exports = {
  QueryPerformanceAnalyzer,
  wrapDatabaseConnection,
  getQueryPerformanceEvents,
  getQueryPerformanceStats,
  resetQueryPerformanceStats,
  queryAnalyzer
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-routes_assignments.html">routes/assignments</a></li><li><a href="module-routes_games.html">routes/games</a></li></ul><h3>Classes</h3><ul><li><a href="AdvancedPerformanceMetrics.html">AdvancedPerformanceMetrics</a></li><li><a href="ApiError.html">ApiError</a></li><li><a href="AppError.html">AppError</a></li><li><a href="ApprovalWorkflowService.html">ApprovalWorkflowService</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="AuthorizationError.html">AuthorizationError</a></li><li><a href="global.html#BaseService">BaseService</a></li><li><a href="BudgetCalculationService.html">BudgetCalculationService</a></li><li><a href="BusinessLogicError.html">BusinessLogicError</a></li><li><a href="ConfigurationError.html">ConfigurationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="DatabaseError.html">DatabaseError</a></li><li><a href="DistanceCalculationService.html">DistanceCalculationService</a></li><li><a href="EncryptionService.html">EncryptionService</a></li><li><a href="ErrorFactory.html">ErrorFactory</a></li><li><a href="ErrorLogger.html">ErrorLogger</a></li><li><a href="ErrorMetrics.html">ErrorMetrics</a></li><li><a href="ErrorUtils.html">ErrorUtils</a></li><li><a href="ExternalServiceError.html">ExternalServiceError</a></li><li><a href="FileProcessingError.html">FileProcessingError</a></li><li><a href="FinancialAIService.html">FinancialAIService</a></li><li><a href="LocationDataService.html">LocationDataService</a></li><li><a href="MetricsCollector.html">MetricsCollector</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PaymentMethodService.html">PaymentMethodService</a></li><li><a href="QueryBuilder.html">QueryBuilder</a></li><li><a href="QueryCache.html">QueryCache</a></li><li><a href="QueryPerformanceAnalyzer.html">QueryPerformanceAnalyzer</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ResponseFormatter.html">ResponseFormatter</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ServiceFactory.html">ServiceFactory</a></li><li><a href="TimeoutError.html">TimeoutError</a></li><li><a href="UnprocessableEntityError.html">UnprocessableEntityError</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AUDIT_EVENTS">AUDIT_EVENTS</a></li><li><a href="global.html#AUDIT_SEVERITY">AUDIT_SEVERITY</a></li><li><a href="global.html#AssignmentSchemas">AssignmentSchemas</a></li><li><a href="global.html#AuthSchemas">AuthSchemas</a></li><li><a href="global.html#AvailabilitySchemas">AvailabilitySchemas</a></li><li><a href="global.html#BaseSchemas">BaseSchemas</a></li><li><a href="global.html#BudgetSchemas">BudgetSchemas</a></li><li><a href="global.html#COMMON_PATTERNS">COMMON_PATTERNS</a></li><li><a href="global.html#CUSTOM_VALIDATORS">CUSTOM_VALIDATORS</a></li><li><a href="global.html#CacheHelpers">CacheHelpers</a></li><li><a href="global.html#CacheInvalidation">CacheInvalidation</a></li><li><a href="global.html#ERROR_MESSAGES">ERROR_MESSAGES</a></li><li><a href="global.html#ERROR_SEVERITY">ERROR_SEVERITY</a></li><li><a href="global.html#ERROR_TYPES">ERROR_TYPES</a></li><li><a href="global.html#FileSchemas">FileSchemas</a></li><li><a href="global.html#FilterSchemas">FilterSchemas</a></li><li><a href="global.html#GameSchemas">GameSchemas</a></li><li><a href="global.html#HTTP_STATUS">HTTP_STATUS</a></li><li><a href="global.html#IdParamSchema">IdParamSchema</a></li><li><a href="global.html#NodeCache">NodeCache</a></li><li><a href="global.html#PaginationSchema">PaginationSchema</a></li><li><a href="global.html#QueryHelpers">QueryHelpers</a></li><li><a href="global.html#SCHEMA_REGISTRY">SCHEMA_REGISTRY</a></li><li><a href="global.html#UserSchemas">UserSchemas</a></li><li><a href="global.html#VALIDATION_OPTIONS">VALIDATION_OPTIONS</a></li><li><a href="global.html#addMinutes">addMinutes</a></li><li><a href="global.html#advancedPerformanceMonitor">advancedPerformanceMonitor</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auditMiddleware">auditMiddleware</a></li><li><a href="global.html#authLimiter">authLimiter</a></li><li><a href="global.html#autoValidate">autoValidate</a></li><li><a href="global.html#calculateAvailabilityScore">calculateAvailabilityScore</a></li><li><a href="global.html#calculateDatabaseHealthScore">calculateDatabaseHealthScore</a></li><li><a href="global.html#calculateEndTime">calculateEndTime</a></li><li><a href="global.html#calculateFinalWage">calculateFinalWage</a></li><li><a href="global.html#checkAssignmentConflicts">checkAssignmentConflicts</a></li><li><a href="global.html#checkGameSchedulingConflicts">checkGameSchedulingConflicts</a></li><li><a href="global.html#checkRefereeDoubleBooking">checkRefereeDoubleBooking</a></li><li><a href="global.html#checkServiceHealth">checkServiceHealth</a></li><li><a href="global.html#checkTimeOverlap">checkTimeOverlap</a></li><li><a href="global.html#checkTravelTimeConflict">checkTravelTimeConflict</a></li><li><a href="global.html#checkVenueConflict">checkVenueConflict</a></li><li><a href="global.html#clearSettingsCache">clearSettingsCache</a></li><li><a href="global.html#conditionalValidation">conditionalValidation</a></li><li><a href="global.html#createAuditLog">createAuditLog</a></li><li><a href="global.html#createAuditLogsTable">createAuditLogsTable</a></li><li><a href="global.html#createPerformanceRoute">createPerformanceRoute</a></li><li><a href="global.html#createSecurityMiddleware">createSecurityMiddleware</a></li><li><a href="global.html#createTableService">createTableService</a></li><li><a href="global.html#createValidationError">createValidationError</a></li><li><a href="global.html#createValidator">createValidator</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#determineErrorSeverity">determineErrorSeverity</a></li><li><a href="global.html#determineEventType">determineEventType</a></li><li><a href="global.html#determineHealthStatus">determineHealthStatus</a></li><li><a href="global.html#determineIfShouldLog">determineIfShouldLog</a></li><li><a href="global.html#determineSeverity">determineSeverity</a></li><li><a href="global.html#enforceHTTPS">enforceHTTPS</a></li><li><a href="global.html#enhancedAsyncHandler">enhancedAsyncHandler</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#errorHealthCheck">errorHealthCheck</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#findAvailableReferees">findAvailableReferees</a></li><li><a href="global.html#formatAvailabilityResponse">formatAvailabilityResponse</a></li><li><a href="global.html#formatBytes">formatBytes</a></li><li><a href="global.html#generateAdvancedRecommendations">generateAdvancedRecommendations</a></li><li><a href="global.html#generateCacheRecommendations">generateCacheRecommendations</a></li><li><a href="global.html#generateDatabaseInsights">generateDatabaseInsights</a></li><li><a href="global.html#generateGroupStagePlayoffs">generateGroupStagePlayoffs</a></li><li><a href="global.html#generateHealthRecommendations">generateHealthRecommendations</a></li><li><a href="global.html#generateRecommendations">generateRecommendations</a></li><li><a href="global.html#generateRoundRobin">generateRoundRobin</a></li><li><a href="global.html#generateSingleElimination">generateSingleElimination</a></li><li><a href="global.html#generateSwissSystem">generateSwissSystem</a></li><li><a href="global.html#generateTransactionNumber">generateTransactionNumber</a></li><li><a href="global.html#getAdvancedMetrics">getAdvancedMetrics</a></li><li><a href="global.html#getAggregatedMetrics">getAggregatedMetrics</a></li><li><a href="global.html#getAuditEventType">getAuditEventType</a></li><li><a href="global.html#getClientIP">getClientIP</a></li><li><a href="global.html#getCorsConfig">getCorsConfig</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getMetricsCollector">getMetricsCollector</a></li><li><a href="global.html#getMetricsEvents">getMetricsEvents</a></li><li><a href="global.html#getMetricsSummary">getMetricsSummary</a></li><li><a href="global.html#getMinutesBetween">getMinutesBetween</a></li><li><a href="global.html#getOrganizationSettings">getOrganizationSettings</a></li><li><a href="global.html#getPerformanceEvents">getPerformanceEvents</a></li><li><a href="global.html#getPerformanceStats">getPerformanceStats</a></li><li><a href="global.html#getQueryPerformanceEvents">getQueryPerformanceEvents</a></li><li><a href="global.html#getQueryPerformanceStats">getQueryPerformanceStats</a></li><li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li><li><a href="global.html#getService">getService</a></li><li><a href="global.html#getServices">getServices</a></li><li><a href="global.html#getSlowQueriesSummary">getSlowQueriesSummary</a></li><li><a href="global.html#getWageBreakdown">getWageBreakdown</a></li><li><a href="global.html#handleApprovedRequest">handleApprovedRequest</a></li><li><a href="global.html#handleDatabaseError">handleDatabaseError</a></li><li><a href="global.html#hasSchedulingConflict">hasSchedulingConflict</a></li><li><a href="global.html#initializeServices">initializeServices</a></li><li><a href="global.html#knex">knex</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logRequest">logRequest</a></li><li><a href="global.html#logSuspiciousActivity">logSuspiciousActivity</a></li><li><a href="global.html#logUnauthorizedCorsAttempt">logUnauthorizedCorsAttempt</a></li><li><a href="global.html#metricsEvents">metricsEvents</a></li><li><a href="global.html#notFoundHandler">notFoundHandler</a></li><li><a href="global.html#parseSize">parseSize</a></li><li><a href="global.html#parseSqlQuery">parseSqlQuery</a></li><li><a href="global.html#performanceEvents">performanceEvents</a></li><li><a href="global.html#performanceMonitor">performanceMonitor</a></li><li><a href="global.html#queryAuditLogs">queryAuditLogs</a></li><li><a href="global.html#queryCache">queryCache</a></li><li><a href="global.html#queryPerformanceEvents">queryPerformanceEvents</a></li><li><a href="global.html#queryValidationSchemas">queryValidationSchemas</a></li><li><a href="global.html#requestContextMiddleware">requestContextMiddleware</a></li><li><a href="global.html#requestContexts">requestContexts</a></li><li><a href="global.html#requestSizeLimit">requestSizeLimit</a></li><li><a href="global.html#resetAdvancedMetrics">resetAdvancedMetrics</a></li><li><a href="global.html#resetAllMetrics">resetAllMetrics</a></li><li><a href="global.html#resetPerformanceStats">resetPerformanceStats</a></li><li><a href="global.html#resetQueryPerformanceStats">resetQueryPerformanceStats</a></li><li><a href="global.html#sanitizeAll">sanitizeAll</a></li><li><a href="global.html#sanitizeBody">sanitizeBody</a></li><li><a href="global.html#sanitizeBodyForLogging">sanitizeBodyForLogging</a></li><li><a href="global.html#sanitizeError">sanitizeError</a></li><li><a href="global.html#sanitizeHeaders">sanitizeHeaders</a></li><li><a href="global.html#sanitizeInput">sanitizeInput</a></li><li><a href="global.html#sanitizeObject">sanitizeObject</a></li><li><a href="global.html#sanitizeParams">sanitizeParams</a></li><li><a href="global.html#sanitizeQuery">sanitizeQuery</a></li><li><a href="global.html#sanitizeString">sanitizeString</a></li><li><a href="global.html#securityConfig">securityConfig</a></li><li><a href="global.html#securityMonitoring">securityMonitoring</a></li><li><a href="global.html#sendAlertToWebhook">sendAlertToWebhook</a></li><li><a href="global.html#setupAlertHandlers">setupAlertHandlers</a></li><li><a href="global.html#setupGlobalErrorHandlers">setupGlobalErrorHandlers</a></li><li><a href="global.html#subtractMinutes">subtractMinutes</a></li><li><a href="global.html#testIntegrationConnection">testIntegrationConnection</a></li><li><a href="global.html#trackCacheOperation">trackCacheOperation</a></li><li><a href="global.html#trackDbQuery">trackDbQuery</a></li><li><a href="global.html#updateMetricsConfig">updateMetricsConfig</a></li><li><a href="global.html#validateAvailabilityWindow">validateAvailabilityWindow</a></li><li><a href="global.html#validateBody">validateBody</a></li><li><a href="global.html#validateContentType">validateContentType</a></li><li><a href="global.html#validateEnvironment">validateEnvironment</a></li><li><a href="global.html#validateFile">validateFile</a></li><li><a href="global.html#validateIdParam">validateIdParam</a></li><li><a href="global.html#validateParams">validateParams</a></li><li><a href="global.html#validateQuery">validateQuery</a></li><li><a href="global.html#validateRefereeQualifications">validateRefereeQualifications</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUuidParam">validateUuidParam</a></li><li><a href="global.html#validationSummary">validationSummary</a></li><li><a href="global.html#withDatabaseError">withDatabaseError</a></li><li><a href="global.html#withErrorBoundary">withErrorBoundary</a></li><li><a href="global.html#withServiceTransaction">withServiceTransaction</a></li><li><a href="global.html#wrapDatabaseConnection">wrapDatabaseConnection</a></li><li><a href="global.html#wrapDatabaseQuery">wrapDatabaseQuery</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 01 2025 16:15:52 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
