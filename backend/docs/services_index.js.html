<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Service Factory/Registry - Dependency injection pattern for services
 * 
 * This module provides a centralized way to create and manage service instances,
 * implementing the Factory and Registry patterns for easy dependency injection
 * and service management across the application.
 */

const db = require('../config/database');

// Service imports
const BaseService = require('./BaseService');
const UserService = require('./UserService');
const AssignmentService = require('./AssignmentService');
const GameStateService = require('./GameStateService');

// Service registry to store singleton instances
const serviceRegistry = new Map();

/**
 * Service Factory class
 */
class ServiceFactory {
  constructor() {
    this.db = db;
    this.services = new Map();
  }

  /**
   * Get or create a service instance
   * @param {string} serviceName - Name of the service
   * @param {Object} options - Service options
   * @returns {Object} Service instance
   */
  getService(serviceName, options = {}) {
    // Return existing instance if available (singleton pattern)
    if (this.services.has(serviceName)) {
      return this.services.get(serviceName);
    }

    // Create new service instance
    let service;

    switch (serviceName.toLowerCase()) {
      case 'user':
      case 'userservice':
        service = new UserService(this.db);
        break;

      case 'assignment':
      case 'assignmentservice':
        service = new AssignmentService(this.db);
        break;

      case 'gamestate':
      case 'gamestateservice':
        service = new GameStateService(this.db);
        break;

      // Generic base service for any table
      case 'base':
      case 'baseservice':
        if (!options.tableName) {
          throw new Error('BaseService requires tableName in options');
        }
        service = new BaseService(options.tableName, this.db, options);
        break;

      // Create service for specific tables
      case 'games':
        service = new BaseService('games', this.db, {
          defaultOrderBy: 'game_date',
          defaultOrderDirection: 'asc'
        });
        break;

      case 'teams':
        service = new BaseService('teams', this.db, {
          defaultOrderBy: 'name',
          defaultOrderDirection: 'asc'
        });
        break;

      case 'leagues':
        service = new BaseService('leagues', this.db, {
          defaultOrderBy: 'organization',
          defaultOrderDirection: 'asc'
        });
        break;

      case 'positions':
        service = new BaseService('positions', this.db, {
          defaultOrderBy: 'name',
          defaultOrderDirection: 'asc'
        });
        break;

      case 'referee_levels':
        service = new BaseService('referee_levels', this.db, {
          defaultOrderBy: 'name',
          defaultOrderDirection: 'asc'
        });
        break;

      default:
        throw new Error(`Unknown service: ${serviceName}`);
    }

    // Store in registry for reuse
    this.services.set(serviceName, service);
    return service;
  }

  /**
   * Register a custom service
   * @param {string} name - Service name
   * @param {Object} serviceInstance - Service instance
   */
  registerService(name, serviceInstance) {
    this.services.set(name, serviceInstance);
  }

  /**
   * Check if a service is registered
   * @param {string} name - Service name
   * @returns {boolean} True if service exists
   */
  hasService(name) {
    return this.services.has(name);
  }

  /**
   * Remove a service from the registry
   * @param {string} name - Service name
   */
  unregisterService(name) {
    this.services.delete(name);
  }

  /**
   * Get all registered service names
   * @returns {Array} Array of service names
   */
  getRegisteredServices() {
    return Array.from(this.services.keys());
  }

  /**
   * Clear all services (useful for testing)
   */
  clearServices() {
    this.services.clear();
  }

  /**
   * Create multiple services at once
   * @param {Array} serviceConfigs - Array of service configurations
   * @returns {Object} Object with service instances
   */
  createServices(serviceConfigs) {
    const services = {};

    serviceConfigs.forEach(config => {
      const { name, type, options } = config;
      services[name] = this.getService(type, options);
    });

    return services;
  }
}

// Create singleton factory instance
const serviceFactory = new ServiceFactory();

/**
 * Convenience functions for common services
 */
const getServices = () => ({
  user: serviceFactory.getService('user'),
  assignment: serviceFactory.getService('assignment'),
  gameState: serviceFactory.getService('gamestate'),
  games: serviceFactory.getService('games'),
  teams: serviceFactory.getService('teams'),
  leagues: serviceFactory.getService('leagues'),
  positions: serviceFactory.getService('positions'),
  refereeLevels: serviceFactory.getService('referee_levels')
});

/**
 * Get a specific service by name
 * @param {string} serviceName - Name of the service
 * @param {Object} options - Service options
 * @returns {Object} Service instance
 */
const getService = (serviceName, options) => {
  return serviceFactory.getService(serviceName, options);
};

/**
 * Create a service for any table
 * @param {string} tableName - Database table name
 * @param {Object} options - Service options
 * @returns {BaseService} Service instance
 */
const createTableService = (tableName, options = {}) => {
  return new BaseService(tableName, db, options);
};

/**
 * Service initialization helper
 * Initialize all core services for the application
 * @param {Object} config - Initialization configuration
 * @returns {Object} Initialized services
 */
const initializeServices = (config = {}) => {
  console.log('Initializing application services...');

  const services = {
    user: serviceFactory.getService('user'),
    assignment: serviceFactory.getService('assignment'),
    gameState: serviceFactory.getService('gamestate')
  };

  // Initialize additional services based on config
  if (config.includeTableServices) {
    services.games = serviceFactory.getService('games');
    services.teams = serviceFactory.getService('teams');
    services.leagues = serviceFactory.getService('leagues');
    services.positions = serviceFactory.getService('positions');
    services.refereeLevels = serviceFactory.getService('referee_levels');
  }

  // Register custom services if provided
  if (config.customServices) {
    Object.entries(config.customServices).forEach(([name, serviceClass]) => {
      const service = new serviceClass(db);
      serviceFactory.registerService(name, service);
      services[name] = service;
    });
  }

  console.log(`Initialized ${Object.keys(services).length} services:`, Object.keys(services));
  return services;
};

/**
 * Transaction helper that provides services within a transaction context
 * @param {Function} callback - Callback function that receives services
 * @returns {*} Transaction result
 */
const withServiceTransaction = async (callback) => {
  const trx = await db.transaction();

  try {
    // Create service instances that use the transaction
    const transactionalServices = {
      user: new UserService(trx),
      assignment: new AssignmentService(trx),
      gameState: new GameStateService(trx),
      // Add more services as needed
    };

    const result = await callback(transactionalServices, trx);
    await trx.commit();
    return result;
  } catch (error) {
    await trx.rollback();
    console.error('Service transaction failed:', error);
    throw error;
  }
};

/**
 * Health check for all services
 * @returns {Object} Health status of all services
 */
const checkServiceHealth = async () => {
  const services = getServices();
  const healthStatus = {
    overall: 'healthy',
    services: {},
    timestamp: new Date(),
    database: {
      connected: false,
      responseTime: null
    }
  };

  try {
    // Check database connectivity
    const start = Date.now();
    await db.raw('SELECT 1');
    healthStatus.database.connected = true;
    healthStatus.database.responseTime = Date.now() - start;

    // Test each service with a simple operation
    for (const [name, service] of Object.entries(services)) {
      try {
        // Test basic functionality - for BaseService extensions, try a count query
        if (service.findWithPagination) {
          await service.findWithPagination({}, 1, 1);
        }
        healthStatus.services[name] = 'healthy';
      } catch (error) {
        console.error(`Service ${name} health check failed:`, error);
        healthStatus.services[name] = 'unhealthy';
        healthStatus.overall = 'degraded';
      }
    }

  } catch (error) {
    console.error('Database connectivity check failed:', error);
    healthStatus.database.connected = false;
    healthStatus.overall = 'unhealthy';
  }

  return healthStatus;
};

module.exports = {
  // Factory instance
  serviceFactory,

  // Convenience functions
  getServices,
  getService,
  createTableService,

  // Service classes (for direct instantiation if needed)
  BaseService,
  UserService,
  AssignmentService,
  GameStateService,

  // Utility functions
  initializeServices,
  withServiceTransaction,
  checkServiceHealth
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-routes_assignments.html">routes/assignments</a></li><li><a href="module-routes_games.html">routes/games</a></li></ul><h3>Classes</h3><ul><li><a href="AdvancedPerformanceMetrics.html">AdvancedPerformanceMetrics</a></li><li><a href="ApiError.html">ApiError</a></li><li><a href="AppError.html">AppError</a></li><li><a href="ApprovalWorkflowService.html">ApprovalWorkflowService</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="AuthorizationError.html">AuthorizationError</a></li><li><a href="global.html#BaseService">BaseService</a></li><li><a href="BudgetCalculationService.html">BudgetCalculationService</a></li><li><a href="BusinessLogicError.html">BusinessLogicError</a></li><li><a href="ConfigurationError.html">ConfigurationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="DatabaseError.html">DatabaseError</a></li><li><a href="DistanceCalculationService.html">DistanceCalculationService</a></li><li><a href="EncryptionService.html">EncryptionService</a></li><li><a href="ErrorFactory.html">ErrorFactory</a></li><li><a href="ErrorLogger.html">ErrorLogger</a></li><li><a href="ErrorMetrics.html">ErrorMetrics</a></li><li><a href="ErrorUtils.html">ErrorUtils</a></li><li><a href="ExternalServiceError.html">ExternalServiceError</a></li><li><a href="FileProcessingError.html">FileProcessingError</a></li><li><a href="FinancialAIService.html">FinancialAIService</a></li><li><a href="LocationDataService.html">LocationDataService</a></li><li><a href="MetricsCollector.html">MetricsCollector</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PaymentMethodService.html">PaymentMethodService</a></li><li><a href="QueryBuilder.html">QueryBuilder</a></li><li><a href="QueryCache.html">QueryCache</a></li><li><a href="QueryPerformanceAnalyzer.html">QueryPerformanceAnalyzer</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ResponseFormatter.html">ResponseFormatter</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ServiceFactory.html">ServiceFactory</a></li><li><a href="TimeoutError.html">TimeoutError</a></li><li><a href="UnprocessableEntityError.html">UnprocessableEntityError</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AUDIT_EVENTS">AUDIT_EVENTS</a></li><li><a href="global.html#AUDIT_SEVERITY">AUDIT_SEVERITY</a></li><li><a href="global.html#AssignmentSchemas">AssignmentSchemas</a></li><li><a href="global.html#AuthSchemas">AuthSchemas</a></li><li><a href="global.html#AvailabilitySchemas">AvailabilitySchemas</a></li><li><a href="global.html#BaseSchemas">BaseSchemas</a></li><li><a href="global.html#BudgetSchemas">BudgetSchemas</a></li><li><a href="global.html#COMMON_PATTERNS">COMMON_PATTERNS</a></li><li><a href="global.html#CUSTOM_VALIDATORS">CUSTOM_VALIDATORS</a></li><li><a href="global.html#CacheHelpers">CacheHelpers</a></li><li><a href="global.html#CacheInvalidation">CacheInvalidation</a></li><li><a href="global.html#ERROR_MESSAGES">ERROR_MESSAGES</a></li><li><a href="global.html#ERROR_SEVERITY">ERROR_SEVERITY</a></li><li><a href="global.html#ERROR_TYPES">ERROR_TYPES</a></li><li><a href="global.html#FileSchemas">FileSchemas</a></li><li><a href="global.html#FilterSchemas">FilterSchemas</a></li><li><a href="global.html#GameSchemas">GameSchemas</a></li><li><a href="global.html#HTTP_STATUS">HTTP_STATUS</a></li><li><a href="global.html#IdParamSchema">IdParamSchema</a></li><li><a href="global.html#NodeCache">NodeCache</a></li><li><a href="global.html#PaginationSchema">PaginationSchema</a></li><li><a href="global.html#QueryHelpers">QueryHelpers</a></li><li><a href="global.html#SCHEMA_REGISTRY">SCHEMA_REGISTRY</a></li><li><a href="global.html#UserSchemas">UserSchemas</a></li><li><a href="global.html#VALIDATION_OPTIONS">VALIDATION_OPTIONS</a></li><li><a href="global.html#addMinutes">addMinutes</a></li><li><a href="global.html#advancedPerformanceMonitor">advancedPerformanceMonitor</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auditMiddleware">auditMiddleware</a></li><li><a href="global.html#authLimiter">authLimiter</a></li><li><a href="global.html#autoValidate">autoValidate</a></li><li><a href="global.html#calculateAvailabilityScore">calculateAvailabilityScore</a></li><li><a href="global.html#calculateDatabaseHealthScore">calculateDatabaseHealthScore</a></li><li><a href="global.html#calculateEndTime">calculateEndTime</a></li><li><a href="global.html#calculateFinalWage">calculateFinalWage</a></li><li><a href="global.html#checkAssignmentConflicts">checkAssignmentConflicts</a></li><li><a href="global.html#checkGameSchedulingConflicts">checkGameSchedulingConflicts</a></li><li><a href="global.html#checkRefereeDoubleBooking">checkRefereeDoubleBooking</a></li><li><a href="global.html#checkServiceHealth">checkServiceHealth</a></li><li><a href="global.html#checkTimeOverlap">checkTimeOverlap</a></li><li><a href="global.html#checkTravelTimeConflict">checkTravelTimeConflict</a></li><li><a href="global.html#checkVenueConflict">checkVenueConflict</a></li><li><a href="global.html#clearSettingsCache">clearSettingsCache</a></li><li><a href="global.html#conditionalValidation">conditionalValidation</a></li><li><a href="global.html#createAuditLog">createAuditLog</a></li><li><a href="global.html#createAuditLogsTable">createAuditLogsTable</a></li><li><a href="global.html#createPerformanceRoute">createPerformanceRoute</a></li><li><a href="global.html#createSecurityMiddleware">createSecurityMiddleware</a></li><li><a href="global.html#createTableService">createTableService</a></li><li><a href="global.html#createValidationError">createValidationError</a></li><li><a href="global.html#createValidator">createValidator</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#determineErrorSeverity">determineErrorSeverity</a></li><li><a href="global.html#determineEventType">determineEventType</a></li><li><a href="global.html#determineHealthStatus">determineHealthStatus</a></li><li><a href="global.html#determineIfShouldLog">determineIfShouldLog</a></li><li><a href="global.html#determineSeverity">determineSeverity</a></li><li><a href="global.html#enforceHTTPS">enforceHTTPS</a></li><li><a href="global.html#enhancedAsyncHandler">enhancedAsyncHandler</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#errorHealthCheck">errorHealthCheck</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#findAvailableReferees">findAvailableReferees</a></li><li><a href="global.html#formatAvailabilityResponse">formatAvailabilityResponse</a></li><li><a href="global.html#formatBytes">formatBytes</a></li><li><a href="global.html#generateAdvancedRecommendations">generateAdvancedRecommendations</a></li><li><a href="global.html#generateCacheRecommendations">generateCacheRecommendations</a></li><li><a href="global.html#generateDatabaseInsights">generateDatabaseInsights</a></li><li><a href="global.html#generateGroupStagePlayoffs">generateGroupStagePlayoffs</a></li><li><a href="global.html#generateHealthRecommendations">generateHealthRecommendations</a></li><li><a href="global.html#generateRecommendations">generateRecommendations</a></li><li><a href="global.html#generateRoundRobin">generateRoundRobin</a></li><li><a href="global.html#generateSingleElimination">generateSingleElimination</a></li><li><a href="global.html#generateSwissSystem">generateSwissSystem</a></li><li><a href="global.html#generateTransactionNumber">generateTransactionNumber</a></li><li><a href="global.html#getAdvancedMetrics">getAdvancedMetrics</a></li><li><a href="global.html#getAggregatedMetrics">getAggregatedMetrics</a></li><li><a href="global.html#getAuditEventType">getAuditEventType</a></li><li><a href="global.html#getClientIP">getClientIP</a></li><li><a href="global.html#getCorsConfig">getCorsConfig</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getMetricsCollector">getMetricsCollector</a></li><li><a href="global.html#getMetricsEvents">getMetricsEvents</a></li><li><a href="global.html#getMetricsSummary">getMetricsSummary</a></li><li><a href="global.html#getMinutesBetween">getMinutesBetween</a></li><li><a href="global.html#getOrganizationSettings">getOrganizationSettings</a></li><li><a href="global.html#getPerformanceEvents">getPerformanceEvents</a></li><li><a href="global.html#getPerformanceStats">getPerformanceStats</a></li><li><a href="global.html#getQueryPerformanceEvents">getQueryPerformanceEvents</a></li><li><a href="global.html#getQueryPerformanceStats">getQueryPerformanceStats</a></li><li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li><li><a href="global.html#getService">getService</a></li><li><a href="global.html#getServices">getServices</a></li><li><a href="global.html#getSlowQueriesSummary">getSlowQueriesSummary</a></li><li><a href="global.html#getWageBreakdown">getWageBreakdown</a></li><li><a href="global.html#handleApprovedRequest">handleApprovedRequest</a></li><li><a href="global.html#handleDatabaseError">handleDatabaseError</a></li><li><a href="global.html#hasSchedulingConflict">hasSchedulingConflict</a></li><li><a href="global.html#initializeServices">initializeServices</a></li><li><a href="global.html#knex">knex</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logRequest">logRequest</a></li><li><a href="global.html#logSuspiciousActivity">logSuspiciousActivity</a></li><li><a href="global.html#logUnauthorizedCorsAttempt">logUnauthorizedCorsAttempt</a></li><li><a href="global.html#metricsEvents">metricsEvents</a></li><li><a href="global.html#notFoundHandler">notFoundHandler</a></li><li><a href="global.html#parseSize">parseSize</a></li><li><a href="global.html#parseSqlQuery">parseSqlQuery</a></li><li><a href="global.html#performanceEvents">performanceEvents</a></li><li><a href="global.html#performanceMonitor">performanceMonitor</a></li><li><a href="global.html#queryAuditLogs">queryAuditLogs</a></li><li><a href="global.html#queryCache">queryCache</a></li><li><a href="global.html#queryPerformanceEvents">queryPerformanceEvents</a></li><li><a href="global.html#queryValidationSchemas">queryValidationSchemas</a></li><li><a href="global.html#requestContextMiddleware">requestContextMiddleware</a></li><li><a href="global.html#requestContexts">requestContexts</a></li><li><a href="global.html#requestSizeLimit">requestSizeLimit</a></li><li><a href="global.html#resetAdvancedMetrics">resetAdvancedMetrics</a></li><li><a href="global.html#resetAllMetrics">resetAllMetrics</a></li><li><a href="global.html#resetPerformanceStats">resetPerformanceStats</a></li><li><a href="global.html#resetQueryPerformanceStats">resetQueryPerformanceStats</a></li><li><a href="global.html#sanitizeAll">sanitizeAll</a></li><li><a href="global.html#sanitizeBody">sanitizeBody</a></li><li><a href="global.html#sanitizeBodyForLogging">sanitizeBodyForLogging</a></li><li><a href="global.html#sanitizeError">sanitizeError</a></li><li><a href="global.html#sanitizeHeaders">sanitizeHeaders</a></li><li><a href="global.html#sanitizeInput">sanitizeInput</a></li><li><a href="global.html#sanitizeObject">sanitizeObject</a></li><li><a href="global.html#sanitizeParams">sanitizeParams</a></li><li><a href="global.html#sanitizeQuery">sanitizeQuery</a></li><li><a href="global.html#sanitizeString">sanitizeString</a></li><li><a href="global.html#securityConfig">securityConfig</a></li><li><a href="global.html#securityMonitoring">securityMonitoring</a></li><li><a href="global.html#sendAlertToWebhook">sendAlertToWebhook</a></li><li><a href="global.html#setupAlertHandlers">setupAlertHandlers</a></li><li><a href="global.html#setupGlobalErrorHandlers">setupGlobalErrorHandlers</a></li><li><a href="global.html#subtractMinutes">subtractMinutes</a></li><li><a href="global.html#testIntegrationConnection">testIntegrationConnection</a></li><li><a href="global.html#trackCacheOperation">trackCacheOperation</a></li><li><a href="global.html#trackDbQuery">trackDbQuery</a></li><li><a href="global.html#updateMetricsConfig">updateMetricsConfig</a></li><li><a href="global.html#validateAvailabilityWindow">validateAvailabilityWindow</a></li><li><a href="global.html#validateBody">validateBody</a></li><li><a href="global.html#validateContentType">validateContentType</a></li><li><a href="global.html#validateEnvironment">validateEnvironment</a></li><li><a href="global.html#validateFile">validateFile</a></li><li><a href="global.html#validateIdParam">validateIdParam</a></li><li><a href="global.html#validateParams">validateParams</a></li><li><a href="global.html#validateQuery">validateQuery</a></li><li><a href="global.html#validateRefereeQualifications">validateRefereeQualifications</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUuidParam">validateUuidParam</a></li><li><a href="global.html#validationSummary">validationSummary</a></li><li><a href="global.html#withDatabaseError">withDatabaseError</a></li><li><a href="global.html#withErrorBoundary">withErrorBoundary</a></li><li><a href="global.html#withServiceTransaction">withServiceTransaction</a></li><li><a href="global.html#wrapDatabaseConnection">wrapDatabaseConnection</a></li><li><a href="global.html#wrapDatabaseQuery">wrapDatabaseQuery</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 01 2025 16:15:52 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
