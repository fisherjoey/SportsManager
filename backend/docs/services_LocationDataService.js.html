<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/LocationDataService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/LocationDataService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const knex = require('../config/database');

/**
 * Service for managing comprehensive user location data
 * Handles geocoding, address parsing, and location data storage
 */
class LocationDataService {
  /**
   * Create or update comprehensive location data for a user
   * @param {string} userId - User ID
   * @param {string} address - Address string (can be postal code or full address)
   * @param {Object} options - Additional options
   * @returns {Promise&lt;Object>} User location data
   */
  async createOrUpdateUserLocation(userId, address, options = {}) {
    try {
      // Use the existing address service to get comprehensive location data
      const { createAddressService } = require('../../lib/address-service');
      const addressService = createAddressService();
      
      // Search for the address to get detailed components
      const suggestions = await addressService.searchAddresses(address);
      
      if (!suggestions || suggestions.length === 0) {
        throw new Error(`No location data found for address: ${address}`);
      }
      
      // Take the first (most relevant) suggestion
      const locationData = suggestions[0];
      
      // If coordinates are not available, try to geocode
      let coordinates = locationData.coordinates;
      if (!coordinates) {
        coordinates = await this.geocodeAddress(address);
      }
      
      // Prepare user location data
      const userLocationData = {
        user_id: userId,
        full_address: locationData.displayName || address,
        street_number: locationData.streetNumber || null,
        street_name: locationData.streetName || null,
        city: locationData.city || '',
        province: locationData.province || 'AB',
        postal_code: locationData.postalCode || this.extractPostalCode(address),
        country: locationData.country || 'Canada',
        latitude: coordinates?.lat || null,
        longitude: coordinates?.lng || null,
        geocoding_provider: this.determineProvider(),
        geocoding_confidence: locationData.confidence || 0.8,
        address_type: locationData.type || 'address',
        raw_geocoding_data: JSON.stringify(locationData)
      };
      
      // Check if user location already exists
      const existingLocation = await knex('user_locations')
        .where('user_id', userId)
        .first();
      
      let userLocation;
      if (existingLocation) {
        // Update existing location
        [userLocation] = await knex('user_locations')
          .where('user_id', userId)
          .update({
            ...userLocationData,
            updated_at: knex.fn.now()
          })
          .returning('*');
      } else {
        // Create new location
        [userLocation] = await knex('user_locations')
          .insert(userLocationData)
          .returning('*');
      }
      
      console.log(`Location data ${existingLocation ? 'updated' : 'created'} for user ${userId}:`, {
        address: userLocation.full_address,
        coordinates: coordinates ? `${coordinates.lat}, ${coordinates.lng}` : 'Not found',
        provider: userLocation.geocoding_provider
      });
      
      return userLocation;
    } catch (error) {
      console.error('Error creating/updating user location:', error);
      throw new Error(`Failed to process location data for user ${userId}: ${error.message}`);
    }
  }
  
  /**
   * Get user location data
   * @param {string} userId - User ID
   * @returns {Promise&lt;Object|null>} User location data or null if not found
   */
  async getUserLocation(userId) {
    try {
      const userLocation = await knex('user_locations')
        .where('user_id', userId)
        .first();
      
      return userLocation;
    } catch (error) {
      console.error('Error fetching user location:', error);
      throw new Error(`Failed to fetch location data for user ${userId}`);
    }
  }
  
  /**
   * Geocode an address using the maps library
   * @param {string} address - Address to geocode
   * @returns {Promise&lt;Object|null>} Coordinates {lat, lng} or null
   */
  async geocodeAddress(address) {
    try {
      const { geocodeAddress } = require('../../lib/maps');
      return await geocodeAddress(address);
    } catch (error) {
      console.error('Error geocoding address:', error);
      return null;
    }
  }
  
  /**
   * Extract postal code from address string
   * @param {string} address - Address string
   * @returns {string} Postal code or empty string
   */
  extractPostalCode(address) {
    // Canadian postal code pattern: A1A 1A1 or A1A1A1
    const postalCodeRegex = /[A-Za-z]\d[A-Za-z]\s?\d[A-Za-z]\d/;
    const match = address.match(postalCodeRegex);
    return match ? match[0].toUpperCase().replace(/\s/g, ' ') : '';
  }
  
  /**
   * Determine which geocoding provider is being used
   * @returns {string} Provider name
   */
  determineProvider() {
    const googleApiKey = process.env.NEXT_PUBLIC_GOOGLE_PLACES_API_KEY;
    const mapboxToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
    
    if (googleApiKey &amp;&amp; googleApiKey !== 'your_google_places_api_key_here_optional') {
      return 'google';
    } else if (mapboxToken &amp;&amp; mapboxToken !== 'your_mapbox_token_here_optional') {
      return 'mapbox';
    } else {
      return 'nominatim';
    }
  }
  
  /**
   * Batch create/update location data for multiple users
   * @param {Array} userAddresses - Array of {userId, address} objects
   * @returns {Promise&lt;Array>} Array of created/updated location records
   */
  async batchCreateUserLocations(userAddresses) {
    const results = [];
    const errors = [];
    
    console.log(`Processing ${userAddresses.length} user addresses for location data...`);
    
    for (const { userId, address } of userAddresses) {
      try {
        const result = await this.createOrUpdateUserLocation(userId, address);
        results.push(result);
        
        // Add a small delay to respect API rate limits
        await this.delay(100);
      } catch (error) {
        console.error(`Failed to process location for user ${userId}:`, error.message);
        errors.push({
          userId,
          address,
          error: error.message
        });
      }
    }
    
    if (errors.length > 0) {
      console.warn(`Location processing completed with ${errors.length} errors:`, errors);
    }
    
    return {
      successful: results,
      failed: errors,
      totalProcessed: userAddresses.length
    };
  }
  
  /**
   * Update user's existing location with new coordinates if missing
   * @param {string} userId - User ID
   * @returns {Promise&lt;Object|null>} Updated location or null
   */
  async updateLocationWithCoordinates(userId) {
    try {
      const userLocation = await this.getUserLocation(userId);
      
      if (!userLocation) {
        console.log(`No location found for user ${userId}`);
        return null;
      }
      
      // If coordinates are already present, no need to update
      if (userLocation.latitude &amp;&amp; userLocation.longitude) {
        return userLocation;
      }
      
      // Try to geocode the full address
      let coordinates = null;
      if (userLocation.full_address) {
        coordinates = await this.geocodeAddress(userLocation.full_address);
      }
      
      // If that fails, try postal code
      if (!coordinates &amp;&amp; userLocation.postal_code) {
        coordinates = await this.geocodeAddress(userLocation.postal_code);
      }
      
      if (coordinates) {
        const [updatedLocation] = await knex('user_locations')
          .where('user_id', userId)
          .update({
            latitude: coordinates.lat,
            longitude: coordinates.lng,
            updated_at: knex.fn.now()
          })
          .returning('*');
        
        console.log(`Updated coordinates for user ${userId}: ${coordinates.lat}, ${coordinates.lng}`);
        return updatedLocation;
      } else {
        console.warn(`Could not find coordinates for user ${userId}`);
        return userLocation;
      }
    } catch (error) {
      console.error('Error updating location coordinates:', error);
      throw error;
    }
  }
  
  /**
   * Simple delay function to respect API rate limits
   * @param {number} ms - Milliseconds to delay
   */
  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  /**
   * Get all users who need location data created
   * @returns {Promise&lt;Array>} Array of users missing location data
   */
  async getUsersNeedingLocationData() {
    try {
      const users = await knex('users')
        .leftJoin('user_locations', 'users.id', 'user_locations.user_id')
        .where('users.role', 'referee')
        .whereNotNull('users.postal_code')
        .whereNull('user_locations.id')
        .select('users.id as userId', 'users.postal_code', 'users.location', 'users.name');
      
      return users.map(user => ({
        userId: user.userId,
        address: user.location || user.postal_code,
        name: user.name
      }));
    } catch (error) {
      console.error('Error finding users needing location data:', error);
      throw error;
    }
  }
}

module.exports = LocationDataService;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-routes_assignments.html">routes/assignments</a></li><li><a href="module-routes_games.html">routes/games</a></li></ul><h3>Classes</h3><ul><li><a href="AdvancedPerformanceMetrics.html">AdvancedPerformanceMetrics</a></li><li><a href="ApiError.html">ApiError</a></li><li><a href="AppError.html">AppError</a></li><li><a href="ApprovalWorkflowService.html">ApprovalWorkflowService</a></li><li><a href="AuthenticationError.html">AuthenticationError</a></li><li><a href="AuthorizationError.html">AuthorizationError</a></li><li><a href="global.html#BaseService">BaseService</a></li><li><a href="BudgetCalculationService.html">BudgetCalculationService</a></li><li><a href="BusinessLogicError.html">BusinessLogicError</a></li><li><a href="ConfigurationError.html">ConfigurationError</a></li><li><a href="ConflictError.html">ConflictError</a></li><li><a href="DatabaseError.html">DatabaseError</a></li><li><a href="DistanceCalculationService.html">DistanceCalculationService</a></li><li><a href="EncryptionService.html">EncryptionService</a></li><li><a href="ErrorFactory.html">ErrorFactory</a></li><li><a href="ErrorLogger.html">ErrorLogger</a></li><li><a href="ErrorMetrics.html">ErrorMetrics</a></li><li><a href="ErrorUtils.html">ErrorUtils</a></li><li><a href="ExternalServiceError.html">ExternalServiceError</a></li><li><a href="FileProcessingError.html">FileProcessingError</a></li><li><a href="FinancialAIService.html">FinancialAIService</a></li><li><a href="LocationDataService.html">LocationDataService</a></li><li><a href="MetricsCollector.html">MetricsCollector</a></li><li><a href="NotFoundError.html">NotFoundError</a></li><li><a href="PaymentMethodService.html">PaymentMethodService</a></li><li><a href="QueryBuilder.html">QueryBuilder</a></li><li><a href="QueryCache.html">QueryCache</a></li><li><a href="QueryPerformanceAnalyzer.html">QueryPerformanceAnalyzer</a></li><li><a href="RateLimitError.html">RateLimitError</a></li><li><a href="ResponseFormatter.html">ResponseFormatter</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="ServiceFactory.html">ServiceFactory</a></li><li><a href="TimeoutError.html">TimeoutError</a></li><li><a href="UnprocessableEntityError.html">UnprocessableEntityError</a></li><li><a href="ValidationError.html">ValidationError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AUDIT_EVENTS">AUDIT_EVENTS</a></li><li><a href="global.html#AUDIT_SEVERITY">AUDIT_SEVERITY</a></li><li><a href="global.html#AssignmentSchemas">AssignmentSchemas</a></li><li><a href="global.html#AuthSchemas">AuthSchemas</a></li><li><a href="global.html#AvailabilitySchemas">AvailabilitySchemas</a></li><li><a href="global.html#BaseSchemas">BaseSchemas</a></li><li><a href="global.html#BudgetSchemas">BudgetSchemas</a></li><li><a href="global.html#COMMON_PATTERNS">COMMON_PATTERNS</a></li><li><a href="global.html#CUSTOM_VALIDATORS">CUSTOM_VALIDATORS</a></li><li><a href="global.html#CacheHelpers">CacheHelpers</a></li><li><a href="global.html#CacheInvalidation">CacheInvalidation</a></li><li><a href="global.html#ERROR_MESSAGES">ERROR_MESSAGES</a></li><li><a href="global.html#ERROR_SEVERITY">ERROR_SEVERITY</a></li><li><a href="global.html#ERROR_TYPES">ERROR_TYPES</a></li><li><a href="global.html#FileSchemas">FileSchemas</a></li><li><a href="global.html#FilterSchemas">FilterSchemas</a></li><li><a href="global.html#GameSchemas">GameSchemas</a></li><li><a href="global.html#HTTP_STATUS">HTTP_STATUS</a></li><li><a href="global.html#IdParamSchema">IdParamSchema</a></li><li><a href="global.html#NodeCache">NodeCache</a></li><li><a href="global.html#PaginationSchema">PaginationSchema</a></li><li><a href="global.html#QueryHelpers">QueryHelpers</a></li><li><a href="global.html#SCHEMA_REGISTRY">SCHEMA_REGISTRY</a></li><li><a href="global.html#UserSchemas">UserSchemas</a></li><li><a href="global.html#VALIDATION_OPTIONS">VALIDATION_OPTIONS</a></li><li><a href="global.html#addMinutes">addMinutes</a></li><li><a href="global.html#advancedPerformanceMonitor">advancedPerformanceMonitor</a></li><li><a href="global.html#asyncHandler">asyncHandler</a></li><li><a href="global.html#auditMiddleware">auditMiddleware</a></li><li><a href="global.html#authLimiter">authLimiter</a></li><li><a href="global.html#autoValidate">autoValidate</a></li><li><a href="global.html#calculateAvailabilityScore">calculateAvailabilityScore</a></li><li><a href="global.html#calculateDatabaseHealthScore">calculateDatabaseHealthScore</a></li><li><a href="global.html#calculateEndTime">calculateEndTime</a></li><li><a href="global.html#calculateFinalWage">calculateFinalWage</a></li><li><a href="global.html#checkAssignmentConflicts">checkAssignmentConflicts</a></li><li><a href="global.html#checkGameSchedulingConflicts">checkGameSchedulingConflicts</a></li><li><a href="global.html#checkRefereeDoubleBooking">checkRefereeDoubleBooking</a></li><li><a href="global.html#checkServiceHealth">checkServiceHealth</a></li><li><a href="global.html#checkTimeOverlap">checkTimeOverlap</a></li><li><a href="global.html#checkTravelTimeConflict">checkTravelTimeConflict</a></li><li><a href="global.html#checkVenueConflict">checkVenueConflict</a></li><li><a href="global.html#clearSettingsCache">clearSettingsCache</a></li><li><a href="global.html#conditionalValidation">conditionalValidation</a></li><li><a href="global.html#createAuditLog">createAuditLog</a></li><li><a href="global.html#createAuditLogsTable">createAuditLogsTable</a></li><li><a href="global.html#createPerformanceRoute">createPerformanceRoute</a></li><li><a href="global.html#createSecurityMiddleware">createSecurityMiddleware</a></li><li><a href="global.html#createTableService">createTableService</a></li><li><a href="global.html#createValidationError">createValidationError</a></li><li><a href="global.html#createValidator">createValidator</a></li><li><a href="global.html#db">db</a></li><li><a href="global.html#determineErrorSeverity">determineErrorSeverity</a></li><li><a href="global.html#determineEventType">determineEventType</a></li><li><a href="global.html#determineHealthStatus">determineHealthStatus</a></li><li><a href="global.html#determineIfShouldLog">determineIfShouldLog</a></li><li><a href="global.html#determineSeverity">determineSeverity</a></li><li><a href="global.html#enforceHTTPS">enforceHTTPS</a></li><li><a href="global.html#enhancedAsyncHandler">enhancedAsyncHandler</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#errorHealthCheck">errorHealthCheck</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#findAvailableReferees">findAvailableReferees</a></li><li><a href="global.html#formatAvailabilityResponse">formatAvailabilityResponse</a></li><li><a href="global.html#formatBytes">formatBytes</a></li><li><a href="global.html#generateAdvancedRecommendations">generateAdvancedRecommendations</a></li><li><a href="global.html#generateCacheRecommendations">generateCacheRecommendations</a></li><li><a href="global.html#generateDatabaseInsights">generateDatabaseInsights</a></li><li><a href="global.html#generateGroupStagePlayoffs">generateGroupStagePlayoffs</a></li><li><a href="global.html#generateHealthRecommendations">generateHealthRecommendations</a></li><li><a href="global.html#generateRecommendations">generateRecommendations</a></li><li><a href="global.html#generateRoundRobin">generateRoundRobin</a></li><li><a href="global.html#generateSingleElimination">generateSingleElimination</a></li><li><a href="global.html#generateSwissSystem">generateSwissSystem</a></li><li><a href="global.html#generateTransactionNumber">generateTransactionNumber</a></li><li><a href="global.html#getAdvancedMetrics">getAdvancedMetrics</a></li><li><a href="global.html#getAggregatedMetrics">getAggregatedMetrics</a></li><li><a href="global.html#getAuditEventType">getAuditEventType</a></li><li><a href="global.html#getClientIP">getClientIP</a></li><li><a href="global.html#getCorsConfig">getCorsConfig</a></li><li><a href="global.html#getErrorMessage">getErrorMessage</a></li><li><a href="global.html#getMetricsCollector">getMetricsCollector</a></li><li><a href="global.html#getMetricsEvents">getMetricsEvents</a></li><li><a href="global.html#getMetricsSummary">getMetricsSummary</a></li><li><a href="global.html#getMinutesBetween">getMinutesBetween</a></li><li><a href="global.html#getOrganizationSettings">getOrganizationSettings</a></li><li><a href="global.html#getPerformanceEvents">getPerformanceEvents</a></li><li><a href="global.html#getPerformanceStats">getPerformanceStats</a></li><li><a href="global.html#getQueryPerformanceEvents">getQueryPerformanceEvents</a></li><li><a href="global.html#getQueryPerformanceStats">getQueryPerformanceStats</a></li><li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li><li><a href="global.html#getService">getService</a></li><li><a href="global.html#getServices">getServices</a></li><li><a href="global.html#getSlowQueriesSummary">getSlowQueriesSummary</a></li><li><a href="global.html#getWageBreakdown">getWageBreakdown</a></li><li><a href="global.html#handleApprovedRequest">handleApprovedRequest</a></li><li><a href="global.html#handleDatabaseError">handleDatabaseError</a></li><li><a href="global.html#hasSchedulingConflict">hasSchedulingConflict</a></li><li><a href="global.html#initializeServices">initializeServices</a></li><li><a href="global.html#knex">knex</a></li><li><a href="global.html#logError">logError</a></li><li><a href="global.html#logRequest">logRequest</a></li><li><a href="global.html#logSuspiciousActivity">logSuspiciousActivity</a></li><li><a href="global.html#logUnauthorizedCorsAttempt">logUnauthorizedCorsAttempt</a></li><li><a href="global.html#metricsEvents">metricsEvents</a></li><li><a href="global.html#notFoundHandler">notFoundHandler</a></li><li><a href="global.html#parseSize">parseSize</a></li><li><a href="global.html#parseSqlQuery">parseSqlQuery</a></li><li><a href="global.html#performanceEvents">performanceEvents</a></li><li><a href="global.html#performanceMonitor">performanceMonitor</a></li><li><a href="global.html#queryAuditLogs">queryAuditLogs</a></li><li><a href="global.html#queryCache">queryCache</a></li><li><a href="global.html#queryPerformanceEvents">queryPerformanceEvents</a></li><li><a href="global.html#queryValidationSchemas">queryValidationSchemas</a></li><li><a href="global.html#requestContextMiddleware">requestContextMiddleware</a></li><li><a href="global.html#requestContexts">requestContexts</a></li><li><a href="global.html#requestSizeLimit">requestSizeLimit</a></li><li><a href="global.html#resetAdvancedMetrics">resetAdvancedMetrics</a></li><li><a href="global.html#resetAllMetrics">resetAllMetrics</a></li><li><a href="global.html#resetPerformanceStats">resetPerformanceStats</a></li><li><a href="global.html#resetQueryPerformanceStats">resetQueryPerformanceStats</a></li><li><a href="global.html#sanitizeAll">sanitizeAll</a></li><li><a href="global.html#sanitizeBody">sanitizeBody</a></li><li><a href="global.html#sanitizeBodyForLogging">sanitizeBodyForLogging</a></li><li><a href="global.html#sanitizeError">sanitizeError</a></li><li><a href="global.html#sanitizeHeaders">sanitizeHeaders</a></li><li><a href="global.html#sanitizeInput">sanitizeInput</a></li><li><a href="global.html#sanitizeObject">sanitizeObject</a></li><li><a href="global.html#sanitizeParams">sanitizeParams</a></li><li><a href="global.html#sanitizeQuery">sanitizeQuery</a></li><li><a href="global.html#sanitizeString">sanitizeString</a></li><li><a href="global.html#securityConfig">securityConfig</a></li><li><a href="global.html#securityMonitoring">securityMonitoring</a></li><li><a href="global.html#sendAlertToWebhook">sendAlertToWebhook</a></li><li><a href="global.html#setupAlertHandlers">setupAlertHandlers</a></li><li><a href="global.html#setupGlobalErrorHandlers">setupGlobalErrorHandlers</a></li><li><a href="global.html#subtractMinutes">subtractMinutes</a></li><li><a href="global.html#testIntegrationConnection">testIntegrationConnection</a></li><li><a href="global.html#trackCacheOperation">trackCacheOperation</a></li><li><a href="global.html#trackDbQuery">trackDbQuery</a></li><li><a href="global.html#updateMetricsConfig">updateMetricsConfig</a></li><li><a href="global.html#validateAvailabilityWindow">validateAvailabilityWindow</a></li><li><a href="global.html#validateBody">validateBody</a></li><li><a href="global.html#validateContentType">validateContentType</a></li><li><a href="global.html#validateEnvironment">validateEnvironment</a></li><li><a href="global.html#validateFile">validateFile</a></li><li><a href="global.html#validateIdParam">validateIdParam</a></li><li><a href="global.html#validateParams">validateParams</a></li><li><a href="global.html#validateQuery">validateQuery</a></li><li><a href="global.html#validateRefereeQualifications">validateRefereeQualifications</a></li><li><a href="global.html#validateRequest">validateRequest</a></li><li><a href="global.html#validateUuidParam">validateUuidParam</a></li><li><a href="global.html#validationSummary">validationSummary</a></li><li><a href="global.html#withDatabaseError">withDatabaseError</a></li><li><a href="global.html#withErrorBoundary">withErrorBoundary</a></li><li><a href="global.html#withServiceTransaction">withServiceTransaction</a></li><li><a href="global.html#wrapDatabaseConnection">wrapDatabaseConnection</a></li><li><a href="global.html#wrapDatabaseQuery">wrapDatabaseQuery</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Aug 01 2025 16:15:52 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
